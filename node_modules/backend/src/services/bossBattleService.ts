import db from '../database/db';
import { BossBattle } from '../models/BossBattle';

export class BossBattleService {
  /**
   * Get all boss battles
   */
  async getAllBossBattles(): Promise<BossBattle[]> {
    const battles = await db('boss_battles')
      .select('*')
      .orderBy([{ column: 'chapter_id' }, { column: 'order' }]);

    return battles.map(this.parseBossBattle);
  }

  /**
   * Get a specific boss battle by ID
   */
  async getBossBattleById(battleId: string): Promise<BossBattle | null> {
    const battle = await db('boss_battles').where('id', battleId).first();

    if (!battle) {
      return null;
    }

    return this.parseBossBattle(battle);
  }

  /**
   * Get boss battles for a specific chapter
   */
  async getBossBattlesByChapterId(chapterId: string): Promise<BossBattle[]> {
    const battles = await db('boss_battles')
      .where('chapter_id', chapterId)
      .orderBy('order');

    return battles.map(this.parseBossBattle);
  }

  /**
   * Parse boss battle from database (handle JSONB fields)
   */
  private parseBossBattle(battle: any): BossBattle {
    return {
      ...battle,
      initial_state:
        typeof battle.initial_state === 'string'
          ? JSON.parse(battle.initial_state)
          : battle.initial_state,
      victory_conditions:
        typeof battle.victory_conditions === 'string'
          ? JSON.parse(battle.victory_conditions)
          : battle.victory_conditions,
    };
  }
}

export default new BossBattleService();
